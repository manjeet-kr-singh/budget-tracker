<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/layout :: head"></head>

<body th:classappend="${currentUser != null && currentUser.theme == 'DARK' ? 'dark-mode' : ''}">
    <div id="wrapper">
        <div th:replace="fragments/layout :: sidebar"></div>
        <div id="page-content-wrapper">
            <nav th:replace="fragments/layout :: navbar"></nav>
            <div class="container-fluid my-4 px-4">

                <div class="row mb-4 align-items-center">
                    <div class="col-md-4">
                        <h2>Budgets</h2>
                    </div>
                    <div class="col-md-4">
                        <form id="monthForm" action="/budgets" method="get">
                            <input type="month" class="form-control" name="monthSelector" id="monthSelector"
                                th:value="${selectedMonth}" onchange="updatePage(this.value)">
                        </form>
                    </div>
                    <div class="col-md-4 text-end">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal"
                            data-bs-target="#budgetModal">
                            <i class="fas fa-edit"></i> Plan Monthly Budget
                        </button>
                    </div>
                </div>

                <!-- Budget Cards Grid -->
                <div class="row row-cols-1 row-cols-md-3 g-4">
                    <div class="col" th:each="status : ${budgetStatuses}">
                        <div class="card h-100 shadow-sm border-0">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="card-title fw-bold mb-0" th:text="${status.category}">Category</h5>
                                    <div>
                                        <!-- Optional delete if needed, but managing via Plan is better now -->
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between mb-1">
                                    <span class="text-muted small">Spent: <span class="fw-bold text-dark"><span
                                                class="currency-symbol">$</span> <span
                                                th:text="${status.spentAmount}"></span></span></span>
                                    <span class="text-muted small">Budget: <span class="fw-bold text-dark"><span
                                                class="currency-symbol">$</span> <span
                                                th:text="${status.budgetAmount}"></span></span></span>
                                </div>

                                <div class="progress mb-2" style="height: 10px;">
                                    <div class="progress-bar" role="progressbar"
                                        th:classappend="${status.status == 'Safe' ? 'bg-success' : (status.status == 'Warning' ? 'bg-warning' : 'bg-danger')}"
                                        th:style="'width: ' + ${status.percentage > 100 ? 100 : status.percentage} + '%'"
                                        th:aria-valuenow="${status.percentage}" aria-valuemin="0" aria-valuemax="100">
                                    </div>
                                </div>

                                <div class="text-end">
                                    <small th:text="${#numbers.formatDecimal(status.percentage, 1, 1) + '%'}"
                                        th:classappend="${status.status == 'Overspent' ? 'text-danger fw-bold' : 'text-muted'}">
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 text-center mt-5" th:if="${#lists.isEmpty(budgetStatuses)}">
                        <p class="text-muted lead">No budgets set for this month. Click "Plan Monthly Budget" to start.
                        </p>
                    </div>
                </div>

            </div>
            <div th:replace="fragments/layout :: footer"></div>
        </div>
    </div>

    <!-- Monthly Budget Modal -->
    <div class="modal fade" id="budgetModal" tabindex="-1" aria-labelledby="budgetModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="budgetModalLabel">Plan Budget for <span
                            th:text="${selectedMonth}"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form th:action="@{/saveMonthlyBudget}" th:object="${monthlyPlan}" method="post" id="planForm">
                        <input type="hidden" th:field="*{month}">
                        <input type="hidden" th:field="*{year}">

                        <div class="table-responsive">
                            <table class="table table-borderless align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Category</th>
                                        <th>Budget Amount (<span class="currency-symbol">$</span>)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="item, stat : *{categoryBudgets}">
                                        <td>
                                            <input type="hidden"
                                                th:field="*{categoryBudgets[__${stat.index}__].category}">
                                            <span th:text="${item.category.displayName}" class="fw-bold">Category</span>
                                        </td>
                                        <td>
                                            <input type="number" step="0.01" class="form-control budget-input"
                                                th:field="*{categoryBudgets[__${stat.index}__].amount}"
                                                placeholder="0.00" min="0">
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="d-flex justify-content-end align-items-center mt-3 border-top pt-3">
                            <h4 class="me-3">Total Budget:</h4>
                            <h3 class="text-primary fw-bold"><span class="currency-symbol">$</span> <span
                                    id="totalBudgetDisplay">0.00</span></h3>
                            <!-- Calculated via JS -->
                        </div>

                        <div class="modal-footer px-0 pb-0">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save Plan</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="fragments/layout :: scripts"></div>
    <script>
        function updatePage(val) {
            if (!val) return;
            const parts = val.split('-');
            window.location.href = `/budgets?year=${parts[0]}&month=${parts[1]}`;
        }

        // Auto Calculate Total
        document.addEventListener('DOMContentLoaded', function () {
            const inputs = document.querySelectorAll('.budget-input');
            const totalDisplay = document.getElementById('totalBudgetDisplay');

            function calculateTotal() {
                let total = 0;
                inputs.forEach(input => {
                    const val = parseFloat(input.value) || 0;
                    total += val;
                });
                totalDisplay.textContent = total.toFixed(2);
            }

            inputs.forEach(input => {
                input.addEventListener('input', calculateTotal);
            });

            // Initial calc
            calculateTotal();
        });
    </script>
</body>

</html>