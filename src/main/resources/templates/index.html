<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head th:replace="fragments/layout :: head"></head>

<body>

    <div id="wrapper">
        <!-- Sidebar -->
        <div th:replace="fragments/layout :: sidebar"></div>

        <!-- Page Content -->
        <div id="page-content-wrapper">

            <nav th:replace="fragments/layout :: navbar"></nav>

            <div class="container-fluid my-4 px-4">
                <div class="row mb-3 align-items-center">
                    <div class="col-md-6">
                        <h2>Dashboard</h2>
                    </div>
                    <div class="col-md-6 text-end">
                        <form class="d-inline-flex align-items-center">
                            <label for="monthSelector" class="me-2 fw-bold">Period:</label>
                            <input type="month" id="monthSelector" class="form-control w-auto" value="">
                        </form>
                        <a th:href="@{/showNewExpenseForm}" class="btn btn-primary ms-3"><i class="fas fa-plus"></i> Add
                            Expense</a>
                    </div>
                </div>

                <!-- KPI Cards -->
                <div class="row mb-4">
                    <!-- Total Expenses -->
                    <div class="col-md-3">
                        <div class="card text-white bg-primary bg-gradient mb-3 h-100 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title text-uppercase mb-2 opacity-75">Total Expenses</h6>
                                <h3 class="fw-bold" id="kpi-total-expense"><span class="currency-symbol">$</span> 0.00
                                </h3>
                                <small class="opacity-75"><i class="fas fa-calendar-alt"></i> This Month</small>
                            </div>
                        </div>
                    </div>
                    <!-- Today's Spend -->
                    <div class="col-md-3">
                        <div class="card text-white bg-info bg-gradient mb-3 h-100 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title text-uppercase mb-2 opacity-75">Today's Spend</h6>
                                <h3 class="fw-bold" id="kpi-today-expense"><span class="currency-symbol">$</span> 0.00
                                </h3>
                                <small class="opacity-75"><i class="fas fa-clock"></i> Today</small>
                            </div>
                        </div>
                    </div>
                    <!-- Monthly Budget -->
                    <div class="col-md-3">
                        <div class="card text-white bg-warning bg-gradient mb-3 h-100 shadow-sm text-dark">
                            <div class="card-body">
                                <h6 class="card-title text-uppercase mb-2 opacity-75">Monthly Budget</h6>
                                <h3 class="fw-bold" id="kpi-monthly-budget"><span class="currency-symbol">$</span> 0.00
                                </h3>
                                <small class="opacity-75"><i class="fas fa-wallet"></i> Limit</small>
                            </div>
                        </div>
                    </div>
                    <!-- Remaining Budget -->
                    <div class="col-md-3">
                        <div class="card text-white bg-success bg-gradient mb-3 h-100 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title text-uppercase mb-2 opacity-75">Remaining</h6>
                                <h3 class="fw-bold" id="kpi-remaining-budget"><span class="currency-symbol">$</span>
                                    0.00</h3>
                                <small class="opacity-75"><i class="fas fa-piggy-bank"></i> Safe to spend</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="row mb-4">
                    <!-- Category Pie -->
                    <div class="col-md-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header fw-bold">Spending by Category</div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height:300px;">
                                    <canvas id="categoryChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Monthly Trend -->
                    <div class="col-md-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header fw-bold">Monthly Trend</div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height:300px;">
                                    <canvas id="trendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Payment Mode -->
                    <div class="col-md-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-header fw-bold">Payment Mode</div>
                            <div class="card-body">
                                <div class="chart-container" style="position: relative; height:300px;">
                                    <canvas id="paymentChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div th:replace="fragments/layout :: scripts"></div>

    <!-- Dashboard Logic -->
    <script>
        // Chart instances
        let categoryChart = null;
        let trendChart = null;
        let paymentChart = null;

        $(document).ready(function () {
            // Set current month in selector
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const currentMonth = `${year}-${month}`;
            $('#monthSelector').val(currentMonth);

            // Fetch initial data
            fetchDashboardData(currentMonth + '-01');

            // Handle selector change
            $('#monthSelector').change(function () {
                const selected = $(this).val();
                if (selected) {
                    fetchDashboardData(selected + '-01');
                }
            });
        });

        function fetchDashboardData(dateStr) {
            $.ajax({
                url: '/api/dashboard/stats?date=' + dateStr,
                method: 'GET',
                success: function (data) {
                    updateKPIs(data);
                    updateCharts(data);
                },
                error: function (err) {
                    console.error("Error fetching dashboard data", err);
                }
            });
        }

        // formatCurrency is now global


        function updateKPIs(data) {
            $('#kpi-total-expense').text(formatCurrency(data.totalExpense));
            $('#kpi-today-expense').text(formatCurrency(data.todaysExpense));
            $('#kpi-monthly-budget').text(formatCurrency(data.monthlyBudget));

            const remaining = $('#kpi-remaining-budget');
            remaining.text(formatCurrency(data.remainingBudget));

            // Color logic for remaining
            if (data.remainingBudget < 0) {
                remaining.closest('.card').removeClass('bg-success').addClass('bg-danger');
            } else {
                remaining.closest('.card').removeClass('bg-danger').addClass('bg-success');
            }
        }

        function updateCharts(data) {
            // 1. Category Chart
            renderCategoryChart(data.categorySplit);

            // 2. Trend Chart
            renderTrendChart(data.dailyTrend);

            // 3. Payment Chart
            renderPaymentChart(data.paymentModeSplit);
        }

        function renderCategoryChart(dataMap) {
            const labels = Object.keys(dataMap);
            const values = Object.values(dataMap);
            const colors = labels.map(() => getRandomColor());

            if (categoryChart) categoryChart.destroy();

            const ctx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderTrendChart(dataMap) {
            const labels = Object.keys(dataMap);
            const values = Object.values(dataMap);

            if (trendChart) trendChart.destroy();

            const ctx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Expense',
                        data: values,
                        borderColor: '#0d6efd',
                        tension: 0.3,
                        fill: true,
                        backgroundColor: 'rgba(13, 110, 253, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderPaymentChart(dataMap) {
            const labels = Object.keys(dataMap);
            const values = Object.values(dataMap);
            const colors = labels.map(() => getRandomColor());

            if (paymentChart) paymentChart.destroy();

            const ctx = document.getElementById('paymentChart').getContext('2d');
            paymentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
    </script>

</body>

</html>